### ==========================================
### MOVU AUTH SERVICE - API TESTS
### ==========================================
### Usar con Thunder Client o REST Client extension
### ==========================================

@baseUrl = http://localhost:3000
@gatewayUrl = http://localhost:8080

### Variables (actualizar después de cada test)
@accessToken = eyJhbGciOiJIUzI1NiIs...
@refreshToken = eyJhbGciOiJIUzI1NiIs...
@googleIdToken = eyJhbGciOiJSUzI1NiIs...

### ==========================================
### 1. AUTENTICACIÓN TRADICIONAL
### ==========================================

### 1.1 Registro de nuevo usuario
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123"
}

### 1.2 Login con email y password
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "password123"
}

### 1.3 Refresh token
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

### 1.4 Logout
POST {{baseUrl}}/auth/logout
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}"
}

### ==========================================
### 2. AUTENTICACIÓN CON GOOGLE OAUTH 2.0
### ==========================================

### 2.1 Obtener URL de autorización de Google
GET {{baseUrl}}/auth/google

### 2.2 Callback de Google (se ejecuta automáticamente)
### Después de autorizar en Google, serás redirigido a:
### GET http://localhost:3000/auth/google/callback?code=AUTHORIZATION_CODE

### 2.3 Login con Google ID Token (RECOMENDADO para SPAs)
### Primero obtén el ID Token desde tu frontend con Google Sign-In
POST {{baseUrl}}/auth/google/token
Content-Type: application/json

{
  "idToken": "{{googleIdToken}}"
}

### ==========================================
### 3. GESTIÓN DE ROLES (requiere autenticación)
### ==========================================

### 3.1 Crear un nuevo rol
POST {{baseUrl}}/auth/roles
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "role_name": "premium_user"
}

### 3.2 Obtener todos los roles
GET {{baseUrl}}/auth/roles
Authorization: Bearer {{accessToken}}

### 3.3 Asignar rol a usuario
### Reemplazar :userId con el ID del usuario
POST {{baseUrl}}/auth/users/1/roles
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "role_id": 1
}

### 3.4 Obtener roles de un usuario
GET {{baseUrl}}/auth/users/1/roles
Authorization: Bearer {{accessToken}}

### 3.5 Remover rol de un usuario
DELETE {{baseUrl}}/auth/users/1/roles/1
Authorization: Bearer {{accessToken}}

### ==========================================
### 4. PRUEBAS DE INTEGRACIÓN CON GATEWAY
### ==========================================

### 4.1 Register a través del Gateway
POST {{gatewayUrl}}/auth/register
Content-Type: application/json

{
  "username": "gatewayuser",
  "email": "gateway@example.com",
  "password": "password123"
}

### 4.2 Login a través del Gateway
POST {{gatewayUrl}}/auth/login
Content-Type: application/json

{
  "email": "gateway@example.com",
  "password": "password123"
}

### 4.3 Acceder a recurso protegido (ejemplo: movies)
GET {{gatewayUrl}}/movies
Authorization: Bearer {{accessToken}}

### ==========================================
### 5. CASOS DE PRUEBA ESPECÍFICOS
### ==========================================

### 5.1 Intentar registrar email duplicado (debe fallar)
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "username": "testuser2",
  "email": "test@example.com",
  "password": "password123"
}

### 5.2 Login con credenciales incorrectas (debe fallar)
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "wrongpassword"
}

### 5.3 Usar access token inválido (debe fallar)
GET {{baseUrl}}/auth/roles
Authorization: Bearer invalid_token_here

### 5.4 Usar refresh token inválido (debe fallar)
POST {{baseUrl}}/auth/refresh
Content-Type: application/json

{
  "refreshToken": "invalid_refresh_token"
}

### ==========================================
### 6. TESTING DE VINCULAR CUENTAS
### ==========================================

### 6.1 Crear usuario local con email de Gmail
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "username": "localuser",
  "email": "tunombre@gmail.com",
  "password": "localpass123"
}

### 6.2 Ahora login con Google usando el MISMO email
### Esto vinculará la cuenta de Google con la cuenta local
POST {{baseUrl}}/auth/google/token
Content-Type: application/json

{
  "idToken": "{{googleIdToken}}"
}

### 6.3 Verificar que puedes usar ambos métodos de login
### Login tradicional
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "tunombre@gmail.com",
  "password": "localpass123"
}

### Y también login con Google
POST {{baseUrl}}/auth/google/token
Content-Type: application/json

{
  "idToken": "{{googleIdToken}}"
}

### ==========================================
### NOTAS:
### ==========================================
### 
### 1. Después de un login exitoso, copia los tokens
###    de la respuesta y actualiza las variables @accessToken
###    y @refreshToken arriba
###
### 2. Para obtener un Google ID Token de prueba:
###    - Usa Google OAuth 2.0 Playground: 
###      https://developers.google.com/oauthplayground/
###    - O implementa Google Sign-In en tu frontend
###
### 3. Los access tokens expiran en 15 minutos
###    Los refresh tokens expiran en 7 días
###
### 4. El refresh token puede cambiar si está cerca
###    de su expiración (sliding window de 1 día)
###
### ==========================================
